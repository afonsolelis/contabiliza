<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Totais por tag (período)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <%- include('../partials/header.ejs') %>

  <div class="container">
    <h1 class="mb-3">Totais por tag (período)</h1>

    <form method="get" action="/relatorios/totais-periodo" class="row g-3 align-items-end" id="periodForm">
      <div class="col-12 col-sm-4 col-lg-3">
        <label class="form-label">Início
          <input type="date" name="start" value="<%= filters.start %>" class="form-control" id="startDate" />
        </label>
      </div>
      <div class="col-12 col-sm-4 col-lg-3">
        <label class="form-label">Fim
          <input type="date" name="end" value="<%= filters.end %>" class="form-control" id="endDate" />
        </label>
      </div>
      <div class="col-12 col-sm-4 col-lg-3">
        <div class="btn-group w-100" role="group">
          <button type="button" class="btn btn-outline-primary" id="prevMonth">←</button>
          <button type="button" class="btn btn-outline-secondary" id="currentMonth">=</button>
          <button type="button" class="btn btn-outline-primary" id="nextMonth">→</button>
        </div>
      </div>
    </form>

    <section class="mt-4">
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-4 col-lg-3">
          <div class="card text-bg-light">
            <div class="card-body">
              <div class="fw-semibold">Total no período</div>
              <div class="fs-4">R$ <%= money(totalRange) %></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <div id="totalsChart" style="height:360px;"></div>
        </div>
      </div>

      <div id="expensesSection" style="display: none;" class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h4 mb-0">Gastos - <span id="selectedTagName"></span></h2>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="clearExpenses">Limpar</button>
        </div>
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Tipo</th>
                <th>Valor</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="expensesTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/vendor/apexcharts/dist/apexcharts.min.js"></script>
  <script>
    (function ensureApexCharts() {
      if (typeof ApexCharts === 'undefined') {
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/apexcharts@5.3.6';
        document.head.appendChild(s);
      }
    })();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('periodForm');
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');

      function submitForm() {
        if (startDate.value && endDate.value) {
          form.submit();
        }
      }

      startDate.addEventListener('change', submitForm);
      endDate.addEventListener('change', submitForm);
    });
  </script>
  <script>
    // Navegação entre meses
    function navigateToMonth(offset) {
      const currentStart = document.getElementById('startDate').value;
      const date = currentStart ? new Date(currentStart + 'T00:00:00Z') : new Date();

      const targetYear = date.getUTCFullYear();
      const targetMonth = date.getUTCMonth() + offset;

      const firstDay = new Date(Date.UTC(targetYear, targetMonth, 1));
      const lastDay = new Date(Date.UTC(targetYear, targetMonth + 1, 0));

      const startParam = firstDay.toISOString().slice(0, 10);
      const endParam = lastDay.toISOString().slice(0, 10);

      window.location.href = `/relatorios/totais-periodo?start=${startParam}&end=${endParam}`;
    }

    document.getElementById('prevMonth').addEventListener('click', function() {
      navigateToMonth(-1);
    });

    document.getElementById('currentMonth').addEventListener('click', function() {
      window.location.href = '/relatorios/totais-periodo';
    });

    document.getElementById('nextMonth').addEventListener('click', function() {
      navigateToMonth(1);
    });
  </script>
  <script>
    (function () {
      const rows = <%- JSON.stringify(rows || []) %>;
      const categories = rows.map(r => r.tag);
      const data = rows.map(r => Number(r.total));
      const el = document.getElementById('totalsChart');
      if (!el) return;

      const fmtCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(Number(val) || 0);
      const currencyShort = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(Number(val) || 0);
      const dateTimeFormatter = new Intl.DateTimeFormat('pt-BR', { timeZone: 'UTC', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

      async function loadExpenses(tag) {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate || !tag) return;

        try {
          const response = await fetch(`/relatorios/api/expenses-by-tag?start=${startDate}&end=${endDate}&tag=${encodeURIComponent(tag)}`);
          const result = await response.json();

          if (result.expenses) {
            displayExpenses(tag, result.expenses);
          }
        } catch (err) {
          console.error('Erro ao carregar gastos:', err);
          alert('Erro ao carregar gastos. Tente novamente.');
        }
      }

      function displayExpenses(tag, expenses) {
        const section = document.getElementById('expensesSection');
        const tagName = document.getElementById('selectedTagName');
        const tbody = document.getElementById('expensesTableBody');

        tagName.textContent = tag;
        tbody.innerHTML = '';

        if (expenses.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary">Nenhum gasto encontrado</td></tr>';
        } else {
          expenses.forEach(expense => {
            const tr = document.createElement('tr');
            const date = expense.efetivado_em ? dateTimeFormatter.format(new Date(expense.efetivado_em)) : '';
            tr.innerHTML = `
              <td>${date}</td>
              <td>${expense.descricao_gasto || ''}</td>
              <td>${expense.tipo || ''}</td>
              <td>R$ ${fmtCurrency(expense.valor).replace('R$', '').trim()}</td>
              <td class="text-end"><a class="btn btn-sm btn-outline-primary" href="/gastos/${expense.id}/edit">Editar</a></td>
            `;
            tbody.appendChild(tr);
          });
        }

        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
      }

      function clearExpenses() {
        document.getElementById('expensesSection').style.display = 'none';
      }

      document.getElementById('clearExpenses').addEventListener('click', clearExpenses);

      function render() {
        if (typeof ApexCharts === 'undefined') {
          return setTimeout(render, 200);
        }
        const horizontal = categories.length > 7;
        const xaxis = { categories };
        if (horizontal) {
          xaxis.labels = { formatter: currencyShort };
        }
        const yaxis = horizontal
          ? { labels: { formatter: (val) => val } }
          : { labels: { formatter: currencyShort } };

        const chart = new ApexCharts(el, {
          chart: {
            type: 'bar',
            height: 360,
            toolbar: { show: false },
            events: {
              dataPointSelection: function(event, chartContext, config) {
                const dataPointIndex = config.dataPointIndex;
                if (dataPointIndex >= 0 && dataPointIndex < rows.length) {
                  const selectedTag = rows[dataPointIndex].tag;
                  loadExpenses(selectedTag);
                }
              }
            }
          },
          series: [{ name: 'Total', data }],
          xaxis,
          dataLabels: { enabled: false },
          tooltip: { y: { formatter: (val) => fmtCurrency(val) } },
          yaxis,
          colors: ['#6610f2'],
          plotOptions: { bar: { borderRadius: 4, horizontal } },
          states: {
            active: {
              filter: {
                type: 'darken',
                value: 0.5
              }
            }
          }
        });
        chart.render();
      }

      render();
    })();
  </script>
</body>

</html>
