<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <%- include('../partials/header.ejs') %>

    <div class="container">
      <h1 class="mb-3">Dashboard</h1>

      <form method="get" action="/dashboard" class="row g-3 align-items-end">
        <div class="col-12 col-sm-4">
          <label class="form-label">Início
            <input type="date" name="start" value="<%= filters.start %>" class="form-control" />
          </label>
        </div>
        <div class="col-12 col-sm-4">
          <label class="form-label">Fim
            <input type="date" name="end" value="<%= filters.end %>" class="form-control" />
          </label>
        </div>
        <div class="col-12 col-sm-3">
          <label class="form-label">Período
            <select name="period" class="form-select">
              <option value="day" <%=filters.period==='day' ? 'selected' : '' %>>Dia</option>
              <option value="week" <%=filters.period==='week' ? 'selected' : '' %>>Semana</option>
              <option value="month" <%=filters.period==='month' ? 'selected' : '' %>>Mês</option>
            </select>
          </label>
        </div>
        <div class="col-12 col-sm-1">
          <button type="submit" class="btn btn-primary w-100">Aplicar</button>
        </div>
      </form>

      <section class="mt-4">
        <h2 class="h4">Série temporal</h2>
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-4">
            <div class="card text-bg-light">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-semibold">Total no período</div>
                    <div class="fs-4">R$ <%= Number(totalRange).toFixed(2) %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card mb-3">
          <div class="card-body">
            <div id="seriesChart" style="height:300px;"></div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Período</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <% (series || []).forEach(p=> { %>
                <tr>
                  <td>
                    <%= new Date(p.period).toLocaleDateString() %>
                  </td>
                  <td>R$ <%= Number(p.total).toFixed(2) %>
                  </td>
                </tr>
                <% }) %>
            </tbody>
          </table>
        </div>
      </section>

      <section class="mt-4 mb-5">
        <h2 class="h4">Gastos no intervalo</h2>
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Efetivado em</th>
                <th>Descrição</th>
                <th>Tag</th>
                <th>Tipo</th>
                <th>Valor</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% (gastos || []).forEach(g=> { %>
                <tr>
                  <td>
                    <%= new Date(g.efetivado_em).toLocaleString() %>
                  </td>
                  <td>
                    <%= g.descricao_gasto %>
                  </td>
                  <td>
                    <%= g.tag || '' %>
                  </td>
                  <td>
                    <%= g.tipo %>
                  </td>
                  <td>R$ <%= Number(g.valor).toFixed(2) %>
                  </td>
                  <td class="text-end"><a class="btn btn-sm btn-outline-primary"
                      href="/gastos/<%= g.id %>/edit">Editar</a></td>
                </tr>
                <% }) %>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Carrega ApexCharts local (evita CDN) -->
    <script src="/vendor/apexcharts/dist/apexcharts.min.js"></script>
    <script>
      // Fallback para CDN caso o bundle local não esteja disponível
      (function ensureApexCharts(){
        if (typeof ApexCharts === 'undefined') {
          var s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/apexcharts@5.3.6';
          document.head.appendChild(s);
        }
      })();
    </script>
    <script>
      (function () {
        const seriesData = <%- JSON.stringify(series || []) %>;
        const period = '<%= filters.period %>';
        const periodPt = period === 'day' ? 'dia' : (period === 'week' ? 'semana' : 'mês');
        const categories = seriesData.map(p => new Date(p.period).toLocaleDateString());
        const data = seriesData.map(p => Number(p.total));
        const el = document.querySelector('#seriesChart');
        if (!el) return;
        if (typeof ApexCharts === 'undefined') {
          console.warn('ApexCharts não carregado ainda. Tentando novamente...');
          // aguarda o fallback carregar
          return setTimeout(() => (typeof ApexCharts !== 'undefined') && new ApexCharts(el, {
            chart: { type: 'bar', height: 300, toolbar: { show: false } },
            series: [{ name: `Total por ${periodPt}`, data }],
            xaxis: { categories },
            dataLabels: { enabled: false },
            tooltip: { y: { formatter: (val) => `R$ ${Number(val).toFixed(2)}` } },
            yaxis: { labels: { formatter: (val) => `R$ ${Number(val).toFixed(0)}` } },
            colors: ['#0d6efd'],
            plotOptions: { bar: { borderRadius: 4 } }
          }).render(), 300);
        }
        const options = {
          chart: { type: 'bar', height: 300, toolbar: { show: false } },
          series: [{ name: `Total por ${periodPt}`, data }],
          xaxis: { categories },
          dataLabels: { enabled: false },
          tooltip: { y: { formatter: (val) => `R$ ${Number(val).toFixed(2)}` } },
          yaxis: { labels: { formatter: (val) => `R$ ${Number(val).toFixed(0)}` } },
          colors: ['#0d6efd'],
          plotOptions: { bar: { borderRadius: 4 } }
        };
        const chart = new ApexCharts(el, options);
        chart.render();
      })();
    </script>
</body>

</html>
